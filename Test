import { Component, ElementRef, QueryList, ViewChildren } from '@angular/core';
import { Router } from '@angular/router';
import { SchedulerService } from 'src/app/core/services/scheduler.service';
import { EmployeeSearchModel } from 'src/app/shared/models/search.model';
import { OrderSearchModel } from 'src/app/shared/models/search.model';
import { NgbCalendar, NgbDate } from '@ng-bootstrap/ng-bootstrap';
import { FilterByDropDownNamePipe } from 'src/app/shared/pipes/ddlfilter.pipe';
import { FilterService } from 'src/app/shared/services/filter.service';
import { Observable, Subject } from 'rxjs';
import { NgbModal, NgbModalOptions } from '@ng-bootstrap/ng-bootstrap';
import { NgxSpinnerService } from 'ngx-spinner';
import { OrderListComponent } from 'src/app/components/workload/order-list/order-list.component';
import { FormControl, FormGroup, Validators } from '@angular/forms';

type typeCaretTitle = 'Collapse Search' | 'Expand Search';
type typeCaretStyle = 'fa fa-caret-down' | 'fa fa-caret-left';

@Component({
  selector: 'master',
  templateUrl: './master.component.html'
})
export class MasterComponent {
  @ViewChildren('matSelect') matSelect: QueryList<ElementRef>;

  private orderList: OrderListComponent;

  formCtrlWMC = new FormControl();
  formCtrlHeadQuarter = new FormControl();

  employeeSearchModel: EmployeeSearchModel;
  orderSearchModel: OrderSearchModel;

  employeeList: any;
  headQuarters: any;
  dropDownData: any;
  workPeriod: any;
  caretStyle: typeCaretStyle = 'fa fa-caret-down';
  caretTitle: typeCaretTitle = 'Collapse Search';
  disableDateFrom;
  filterValues = {};
  filterSelectObj = [];
  selectedTab: string;
  storage: Storage;


  constructor(private router: Router, private schedulerService: SchedulerService,
    private filterByDropDownNamePipe: FilterByDropDownNamePipe,
    private filterService: FilterService,
    private ngbCalendar: NgbCalendar,
    private spinner: NgxSpinnerService) {
    this.storage = window.localStorage;
    this.employeeSearchModel = new EmployeeSearchModel();
    this.disableDateFrom = (date: NgbDate) => ngbCalendar.getWeekday(date) != 1;//enable only mondays
    this.workPeriod = [{ id: "Week", name: "Week" }, { id: "WeekEnd", name: "WeekEnd" }, { id: "Both", name: "Both" }];
    // Object to create Filter for
    this.filterSelectObj = [
      {
        name: 'WMC',
        columnProp: 'WmcId',
        preSelected: [],
        options: [],
        formCtrl: this.formCtrlWMC
      },
      {
        name: 'Headquarters',
        columnProp: 'HeadquarterId',
        preSelected: [],
        options: [],
        formCtrl: this.formCtrlHeadQuarter
      },
    ]
  }

  ngOnInit() {
    this.redirectToTab('workforce');
    this.getDataForDropDowns();
  }

  getDataForDropDowns(): void {
    this.schedulerService.getDropdownData('workforce').subscribe((res) => {
      this.filterSelectObj[0].options = this.filterByDropDownNamePipe.transform(res.dropdownDetails, 'WMC');
      this.dropDownData = res.dropdownDetails;
      //this.userPreferences = res.userPreference;
      this.setDefaultFilterValue();
      if (res.userPreference) {
        this.employeeSearchModel.WmcId = res.userPreference.wmcId;
        this.populateHeadQuarters(res.userPreference.wmcId, '');
        this.employeeSearchModel.HeadquarterId = res.userPreference.hqId;
        //this.employeeSearchModel.WorkPeriod = res.userPreference.workPeriod;
        // this.employeeSearchModel.EnergyTypeId = res.userPreference.EnergyTypeId;
      }
    });
  }

  setDefaultFilterValue() {
    this.filterValues = JSON.parse(this.storage.getItem(this.selectedTab));
       if (this.filterValues) {
      this.employeeSearchModel.DateFrom = this.filterValues["DateFrom"];
      this.employeeSearchModel.WorkPeriod = this.filterValues["WorkPeriod"];
      this.employeeSearchModel.EnergyTypeId = this.filterValues["EnergyTypeId"];
      this.filterSelectObj[0].preSelected = this.filterValues["WmcId"];
      this.populateHeadQuarters(this.filterSelectObj[0].preSelected, 'mat-select-0')
      this.filterSelectObj[1].preSelected = this.filterValues["HeadquarterId"];
    }
    else {
      this.resetSearchData("GlobalFiltersForm");
    }
  }

  redirectToTab(tabName) {
    this.reset();
    this.selectedTab = tabName;
    this.schedulerService.tabName = tabName;
    this.router.navigate(['/landing/' + tabName]);
  }

  expandCollapseSearch() {
    this.schedulerService.expandSearch = !this.schedulerService.expandSearch;
    this.caretStyle = this.schedulerService.expandSearch ? 'fa fa-caret-down' : 'fa fa-caret-left';
    this.caretTitle = this.schedulerService.expandSearch ? 'Collapse Search' : 'Expand Search';
  }

  resetSearchData(frm): void {
    frm.submitted = false;

    Object.keys(this.employeeSearchModel).forEach(
      (key) => (this.employeeSearchModel[key] = '')
    );

    // // On reset clear localstorage values    
    this.storage.setItem(this.selectedTab, null);
    this.filterService.resetCrewDetails();
    this.filterService.resetOrderDetails();


    this.filterSelectObj[0].preSelected = [];
    this.filterSelectObj[1].preSelected = [];
    this.filterSelectObj[2].preSelected = [];
  }

  // Called on Filter change and ok/cancel is clicked
  filterChange(col, val) {
    if (!this.filterValues) {
      this.filterValues = {};
    }

    this.filterValues[col] = val;
    // this.dataSource.filter = JSON.stringify(this.filterValues);
  }

  cancel(index, filter) {
    filter.formCtrl.setValue('');
    this.filterChange(filter.columnProp, filter.formCtrl.value);
    this.matSelect['_results'][index].close();
  }

  ok(index, filter) {
    this.filterChange(filter.columnProp, filter.formCtrl.value);
    this.matSelect['_results'][index].close();
  }

  reset() {
    this.schedulerService.expandSearch = true;
    this.caretStyle = 'fa fa-caret-down';
    this.caretTitle = 'Expand Search';
  }

  onChange(col: string, value: any): void {
    this.filterChange(col, value);
  }

  /**
  * Populated HeadQuarters on WMC selection
  */
  populateHeadQuarters(wmcIds: string[], elementId: any) {
    if (elementId && elementId === 'mat-select-0') {
      this.filterSelectObj[1].options = [];
      for (var i = 0, len = wmcIds.length; i < len; i++) {
        var hqIds = this.dropDownData.filter(headquarter => headquarter.dropdownName === 'Headquarter' && headquarter.wmcId == wmcIds[i]);
        for (var j = 0, l = hqIds.length; j < l; j++) {
          this.filterSelectObj[1].options.push(hqIds[j]);
        }
      }
    }
  }

  /**
  * Method to set all filter data information
  * returns void
  */
  search(): void {

    this.spinner.show();

    this.filterValues["DateFrom"] = this.employeeSearchModel.DateFrom;
    this.filterValues["WmcId"] = this.filterSelectObj[0].preSelected;
    this.filterValues["HeadquarterId"] = this.filterSelectObj[1].preSelected;
    this.filterValues["WorkPeriod"] = this.employeeSearchModel.WorkPeriod;
    this.filterValues["EnergyTypeId"] = this.employeeSearchModel.EnergyTypeId;

    this.storage.setItem(this.selectedTab, JSON.stringify(this.filterValues));
    this.filterService.updatedDataSelection(this.filterValues);
  }
}
