import { SchedulerService } from 'src/app/core/services/scheduler.service';
import { Component, Input, Output, EventEmitter, SimpleChanges } from '@angular/core';
import { SelectionModel } from '@angular/cdk/collections';
import {
  NgbModal,
  NgbModalOptions,
  ModalDismissReasons,
} from '@ng-bootstrap/ng-bootstrap';

import { CrewWorkEventComponent } from '../crew-work-event/crew-work-event.component';
import { MatTableDataSource } from '@angular/material/table';
import { MatPaginator, PageEvent } from '@angular/material/paginator';
import { MatDialog, MatDialogConfig } from '@angular/material/dialog';


export interface PeriodicElement {
  employeeTypeId: number;
  headquarter: string;
  id: number;
  employeeName: string;
  employeeType: string;
  Status: string;
  mon: string;
  tues: string;
  wed: string;
  thur: string;
  fri: string;
  sat: string;
  sun: string;
}

@Component({
  selector: 'crew-composition',
  templateUrl: './crew-composition.component.html'
})

export class CrewCompositionComponent {
  @Input() data: any;
  @Input() crewList: any = [];

  selectedCrewLeadData = [];
  lstCrew: any = [];
  displayCrewComposition: boolean = false;
  displayCrewCompostionTable = false;

  @Output() outputEmployeeList = new EventEmitter<any>();

  dataSource = new MatTableDataSource<PeriodicElement>();
  tableDataSource = new MatTableDataSource<any>();
  selection = new SelectionModel<PeriodicElement>(true, []);

  constructor(private modalService: NgbModal, private schedulerService: SchedulerService,
    private dialog: MatDialog) {
  }

  ngOnInit() {
    this.selectedCrewLeadData = this.data;
    this.displayCrewCompostionTable = true;

    this.schedulerService.formCrewSubject.subscribe(() => {
      this.displayCrewComposition = true;
      this.lstCrew.push(this.schedulerService.selectedCrewMembers);
      this.schedulerService.selectedCrewMembers = [];
    });
  }

  private getDismissReason(reason: any): string {
    if (reason === ModalDismissReasons.ESC) {
      return 'by pressing ESC';
    } else if (reason === ModalDismissReasons.BACKDROP_CLICK) {
      return 'by clicking on a backdrop';
    } else {
      return `with: ${reason}`;
    }
  }

  showCrewCompostionTableData() {
    if (this.displayCrewCompostionTable && this.selectedCrewLeadData.length > 0) { return true }
  }

  delete(index) {
    this.displayCrewCompostionTable = false;

    if (this.selectedCrewLeadData.length !== 0) {
      let del = this.selectedCrewLeadData.splice(index, 1);

      this.displayCrewCompostionTable = true;
    } else {
      this.selectedCrewLeadData = [];
      this.displayCrewCompostionTable = false;
    }
  }

  removeItems(arrIndex, tdIndex, key) {
    this.selectedCrewLeadData[arrIndex][tdIndex][key] = "";
  }

  editItems(arrIndex, tdIndex, key, time, items) {
    var timeList = time.split('-');
    var getObj = {};
    if (arrIndex !== '' && tdIndex !== '' && key !== '' && time !== '') {
      getObj['name'] = this.selectedCrewLeadData[arrIndex][tdIndex]['name'];
      getObj['crewType'] = items['crewType'];
      getObj['truckId'] = items['truckId'];
      getObj['crewLeadName'] = items['crewLeadName'];
      getObj['headquarter'] = this.selectedCrewLeadData[arrIndex][tdIndex]['headquarter'];
      // getObj['wmcid'] = this.selectedCrewLeadData[arrIndex][tdIndex]['wmcid'];
      getObj['startTime'] = timeList[0];
      getObj['toTime'] = timeList[1];
      getObj['employeeList'] = [];
      getObj['crewTypeList'] = [];

      this.selectedCrewLeadData[arrIndex].map(item => {
        getObj['employeeList'].push(item.name);
        getObj['crewTypeList'].push(item.employeeType)
      })
    }

    const dialogConfig = new MatDialogConfig();
    dialogConfig.disableClose = true;
    dialogConfig.autoFocus = true;
    dialogConfig.width = '800px';
    dialogConfig.height = '650px';

    dialogConfig.data = {
      id: 1,
      type: 'edit',
      title: 'Work Event',
      formData: getObj,
    };

    const confirmDialog = this.dialog.open(CrewWorkEventComponent, dialogConfig);
    confirmDialog.afterClosed().subscribe(result => {
      if (result) {
        this.patchData(arrIndex, tdIndex, key, result)
      }
    });
  }

  async patchData(arrInd, tdI, key, data) {
    // let hrs = data.toTime - data.fromTime;
    let totHrs: any;
    // var time_start = new Date();
    // var time_end = new Date();
    var value_start = data.fromTime.split(':');
    var value_end = data.toTime.split(':');

    // time_start.setHours(value_start[0], value_start[1], 0, 0)
    // time_end.setHours(value_end[0], value_end[1], 0, 0)

    //  (time_end) - (time_start)
    // let frmTme = time_start.getTime();
    // let toTme = time_end.getTime();
    totHrs = Number(value_end[0]) - Number(value_start[0]);
    // let totDay = Math.floor(totHrs / 1000 % 60)

    // console.log(time_start , time_end)

    let Days = ['sun', 'mon', 'tues', 'wed', 'thur', 'fri', 'sat'];
    let timeVal = "";
    timeVal = totHrs.toString() + " (" + data.fromTime + "-" + data.toTime + ")"
    console.log(this.selectedCrewLeadData);
    this.selectedCrewLeadData[arrInd][tdI][key] = timeVal;
    // await this.apiService.editData(url, data).subscribe(
    //   (res) => {
    //     this.loadRows();
    //   }
    // )
  }

  valSecData(getValue) {
    var vaule = getValue.split("</n>")
    return vaule
  }

  validateData(getValue) {
    var vaule = getValue.replace(/<\/n>/g, "")
    return vaule
  }

  customStyle(index) {
    let style = "paddingBottom marginBottom"
    if (index === 0) { return style }
  }

  shiftCheck(getItem, rtnVal) {
    let str = "";
    // if(getItem.mon !== "" && getItem.mon !== 0){ this.shiftDays += ("M");}
    // if(getItem.tues !== "" && getItem.tues !== 0){this.shiftDays += ("T");}
    // console.log(this.shiftDays)
  }
}
