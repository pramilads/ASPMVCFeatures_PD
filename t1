import { SchedulerService } from 'src/app/core/services/scheduler.service';
import { Component, ViewChild, EventEmitter, Input, OnInit, Output, SimpleChanges } from '@angular/core';
import {
  NgbModal,
  NgbModalOptions,
  ModalDismissReasons,
} from '@ng-bootstrap/ng-bootstrap';

import { EmployeeEditComponent } from '../employee-edit/employee-edit.component';
import { CrewWorkEventComponent } from '../crew-work-event/crew-work-event.component'

import { SelectionModel } from '@angular/cdk/collections';
import { MatTableDataSource } from '@angular/material/table';
import { MatSort } from '@angular/material/sort';
import { MatPaginator } from '@angular/material/paginator';
import { NgxSpinnerService } from 'ngx-spinner';
import { MatDialog, MatDialogConfig } from '@angular/material/dialog';

// import { TextTransformPipe} from 'src/app/shared/pipes//text-pipe';

export interface PeriodicElement {
  headquarter: string;
  name: string;
  employeeType: string;
  status: string;
  mon: string;
  tues: string;
  wed: string;
  thur: string;
  fri: string;
  sat: string;
  sun: string;
}

@Component({
  selector: 'app-crew-info',
  templateUrl: 'crew-info.component.html',
})

export class CrewInfoComponent implements OnInit {
  displayedColumns: string[] = ['select', 'headquarter', 'name', 'employeeType', 'status', 'mon', 'tues', 'wed', 'thur', 'fri', 'sat', 'sun'];
  secondDisplayedColumns: string[] = ['select', 'name', 'mon', 'tues', 'wed', 'thur', 'fri', 'sat', 'sun'];
  @Input() crewList: any = [];
  @Input() empResp: any;

  TruckIdList = [];
  CrewTypeList = [];
  CrewLeadList = [];

  //*** Sorting ***//
  @ViewChild(MatSort, { static: true }) sort: MatSort;

  //*** MatPaginator Starts ***//
  length: number;
  pageSize: number = 50;
  nextPageLabel: String = "Page Size";
  pageSizeOptions = [10, 20, 30, 40, 50];
  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;
  //*** MatPaginator Ends ***//

  sortedEmployeeList = new MatTableDataSource<PeriodicElement>();
  @Output() outputEmployeeList = new EventEmitter<any>();

  formCrewDisabled: boolean = true;
  selection = new SelectionModel<PeriodicElement>(true, []);
  selectedEmployees = [];
  selectedList = [];
  selectedDialogObj = {};
  //splitHours = [];
  displayCrewCompostionTable = false;
  //displayCrewComp = false;


  constructor(private modalService: NgbModal, private schedulerService: SchedulerService,
    private spinner: NgxSpinnerService, private dialog: MatDialog
    // private filterByTextPipe: TextTransformPipe,
  ) { }


  ngAfterViewInit() {
    this.sortedEmployeeList.paginator = this.paginator;
    this.sortedEmployeeList.sort = this.sort;
  }

  ngOnInit(): void {
    this.crewList.map(element => {
      this.TruckIdList.push(element.id);
      this.CrewTypeList.push(element.employeeType);
      //this.CrewLeadList.push(element.name);
    });

    this.sortedEmployeeList = new MatTableDataSource(this.crewList);
    this.sortedEmployeeList.sort = this.sort;
    this.sortedEmployeeList.paginator = this.paginator;
    this.sortedEmployeeList.paginator._intl.itemsPerPageLabel = "Page Size: ";
  }

  ngOnChanges(changes: SimpleChanges) {
    this.sortedEmployeeList = changes.crewList?.currentValue;
  }

  showDialogData() {
    var getObj = {};
    getObj['employeeList'] = [];
    getObj['TruckIdList'] = this.TruckIdList;
    getObj['CrewTypeList'] = this.CrewTypeList;

    this.selection.selected.map(item => {
      getObj['employeeList'].push(item.name);
    })

    const dialogConfig = new MatDialogConfig();
    dialogConfig.disableClose = true;
    dialogConfig.autoFocus = true;
    dialogConfig.width = '450px';
    dialogConfig.height = '430px';

    dialogConfig.data = {
      id: 1,
      type: 'dialog',
      title: 'Crew Types',
      formData: getObj,
    };

    const confirmDialog = this.dialog.open(CrewWorkEventComponent, dialogConfig);
    confirmDialog.afterClosed().subscribe(result => {
      if (result) {
        this.selectedDialogObj = Object.assign({}, result);
        console.log("result...." + JSON.stringify(result));
        this.dataSelection();
        // this.patchData(arrIndex, tdIndex, key, result)
      }
    });
  }

  editEmployee(ind): void {
    let empId = this.sortedEmployeeList['filteredData'][ind]['id']
    const modalOptions: NgbModalOptions = {
      size: 'lg',
      keyboard: false,
      backdrop: 'static',
    };
    const modalRef = this.modalService.open(
      EmployeeEditComponent,
      modalOptions
    );
    const empInfo = JSON.parse(JSON.stringify(this.crewList)); // get a copy of employee list
    modalRef.componentInstance.inputEmployeeInfo = empInfo.filter(
      (emp) => emp.id === empId
    )[0];

    modalRef.result.then(
      (resolveReason) => {
        if (resolveReason === 'save') {
          this.outputEmployeeList.emit();
        } else if (resolveReason === 'cancel') {
          alert('do nothing');
        }
      },
      (rejectReason) => {
        alert(`Dismissed ${this.getDismissReason(rejectReason)}`);
      }
    );
  }

  private getDismissReason(reason: any): string {
    if (reason === ModalDismissReasons.ESC) {
      return 'by pressing ESC';
    } else if (reason === ModalDismissReasons.BACKDROP_CLICK) {
      return 'by clicking on a backdrop';
    } else {
      return `with: ${reason}`;
    }
  }

  setSelectedCrewMembers(evt, emp) {
    this.schedulerService.selectedCrewMembers.push(emp);
    emp['isSelected'] = evt.target.checked;
    this.formCrewDisabled = false;
  }

  // formCrew() {
  //   alert("formCrew");
  //   this.schedulerService.formCrewSubject.next();
  //   this.sortedEmployeeList.data.forEach(emp => emp.isSelected = false);
  //   this.formCrewDisabled = true;
  // }


  isAllSelected() {
    this.selectedEmployees = [];
    const numSelected = this.selection.selected.length;
    const numRows = this.sortedEmployeeList.data.length;
    return numSelected === numRows;
  }

  masterToggle() {
    this.isAllSelected() ?
      this.selection.clear() :
      this.sortedEmployeeList.data.forEach(row => this.selection.select(row));
  }

  valSecData(getValue) {
    var vaule = getValue.split("</n>")
    return vaule
  }

  validateData(getValue) {
    var vaule = getValue.replace(/<\/n>/g, " ")
    return vaule
  }

  move(input,from,to) {
   let deleted = 1;
   const elem = input.splice(from,deleted)[0];

   deleted = 0;
   input.splice(to,deleted,elem);
   console.log("hhh..."+JSON.stringify(input));

  }
  
  dataSelection() {
    var leadObj = {};
    var changedObj = false;
    var copyList =[];
    var leadIndex = 0;
    

    console.log("kkkkkkkkkkkk..."+JSON.stringify(this.selectedList));

    this.selectedList = Object.assign([], this.selection.selected);
    copyList = Object.assign([], this.selection.selected);

    console.log("kkkkkkkkkkkk..."+JSON.stringify(copyList));

    copyList = copyList.map((obj, index) => {
      if (obj.name === this.selectedDialogObj['crewLead']) {
      leadIndex = index;
      var result  = this.move(copyList,leadIndex,0);
      }
    })

    if (changedObj) {
      this.selectedList = this.selectedList.map(objName => {
       return objName.name !== leadObj['name'] ? objName : leadObj
      });
    }

    console.log("mmm..."+JSON.stringify(copyList));

    this.selection.clear();
    this.logSelection();
  }

  logSelection() {
    console.log(JSON.stringify(this.selectedList))
    let Table = [];
    var secondList = [];
    var replaceObj = {};

    if (this.selectedList.length > 1) {
      for (let s of this.selectedList) {
        var originalObj = s;
        replaceObj = Object.assign({}, s);
        for (let key in replaceObj) {
          if (key === "sun" || key === "mon" || key === "tues" || key === "wed" || key === "thur" || key === "fri" || key === "sat") {
            let obj = this.valSecData(replaceObj[key]); //received list
            var tempObj = []
            for (let ind of obj) {
              let indKey = ind.substring(
                ind.lastIndexOf("(") + 1,
                ind.lastIndexOf(")")
              );
              console.log(indKey)
              if (indKey !== '') {
                tempObj.push(indKey)
              }
            }
            replaceObj[key] = tempObj

          }
        }
        Table.push(replaceObj);
        // s=originalObj
      };

      Table['crewType'] = this.selectedDialogObj['crewType'];
      Table['truckId'] = this.selectedDialogObj['truckId'];
      Table['crewLeadName'] = this.selectedDialogObj['crewLead'];

      this.selectedEmployees.push(Table)
      console.log(JSON.stringify(this.selectedEmployees))
      console.log(this.selection.selected)
      console.log(this.sortedEmployeeList)
      this.displayCrewCompostionTable = true;
    }
  }
}
